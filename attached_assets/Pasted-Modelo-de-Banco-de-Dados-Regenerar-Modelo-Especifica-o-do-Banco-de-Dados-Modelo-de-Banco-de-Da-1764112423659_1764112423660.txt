Modelo de Banco de Dados
Regenerar Modelo
Especificação do Banco de Dados
# Modelo de Banco de Dados - BÍBLIA+

## 1. Estrutura Principal

### 1.1 Tabelas de Usuários e Perfis

```sql
-- Tabela principal de usuários (extensão do auth.users do Supabase)
CREATE TABLE users (
    id UUID REFERENCES auth.users(id) PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    full_name VARCHAR(255),
    avatar_url TEXT,
    profile_type VARCHAR(50) NOT NULL DEFAULT 'basic_user',
    -- Perfis: super_admin, church_admin, group_leader, advanced_study, premium_user, basic_user
    church_id UUID REFERENCES churches(id),
    theological_background TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    last_login TIMESTAMPTZ,
    subscription_expires_at TIMESTAMPTZ,
    preferences JSONB DEFAULT '{}'::JSONB
);

-- Tabela de igrejas/organizações
CREATE TABLE churches (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    denomination VARCHAR(100),
    country VARCHAR(100),
    city VARCHAR(100),
    sso_config JSONB,
    admin_id UUID REFERENCES users(id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tabela de grupos comunitários
CREATE TABLE groups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    church_id UUID REFERENCES churches(id),
    leader_id UUID REFERENCES users(id),
    is_public BOOLEAN DEFAULT true,
    max_members INTEGER DEFAULT 50,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 1.2 Tabelas de Conteúdo Bíblico

```sql
-- Tabela de traduções bíblicas
CREATE TABLE bible_translations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL, -- 'NVI', 'ARA', 'ACF', etc.
    language VARCHAR(50) NOT NULL DEFAULT 'portuguese',
    abbreviation VARCHAR(10) NOT NULL,
    copyright_info TEXT,
    is_available BOOLEAN DEFAULT true,
    access_level VARCHAR(20) DEFAULT 'free' -- free, premium, advanced
);

-- Tabela de livros da Bíblia
CREATE TABLE bible_books (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    abbreviation VARCHAR(10) NOT NULL,
    testament VARCHAR(10) NOT NULL, -- old, new
    order_index INTEGER NOT NULL,
    chapter_count INTEGER NOT NULL
);

-- Tabela de capítulos
CREATE TABLE bible_chapters (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    book_id UUID REFERENCES bible_books(id) NOT NULL,
    chapter_number INTEGER NOT NULL,
    verse_count INTEGER NOT NULL,
    UNIQUE(book_id, chapter_number)
);

-- Tabela principal de versículos
CREATE TABLE bible_verses (
    id UUID PRIMARY DEFAULT gen_random_uuid(),
    translation_id UUID REFERENCES bible_translations(id) NOT NULL,
    book_id UUID REFERENCES bible_books(id) NOT NULL,
    chapter_number INTEGER NOT NULL,
    verse_number INTEGER NOT NULL,
    verse_text TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(translation_id, book_id, chapter_number, verse_number)
);

-- Tabela de referências cruzadas
CREATE TABLE cross_references (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    source_verse_id UUID REFERENCES bible_verses(id) NOT NULL,
    target_verse_id UUID REFERENCES bible_verses(id) NOT NULL,
    reference_type VARCHAR(50), -- parallel, explanation, prophecy, etc.
    strength_score DECIMAL(3,2) DEFAULT 1.0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 1.3 Tabelas de Estudo Pessoal

```sql
-- Tabela de planos de leitura
CREATE TABLE reading_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    plan_type VARCHAR(50) NOT NULL, -- chronological, thematic, book_by_book
    duration_days INTEGER NOT NULL,
    is_public BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tabela de itens do plano de leitura
CREATE TABLE reading_plan_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    plan_id UUID REFERENCES reading_plans(id) NOT NULL,
    book_id UUID REFERENCES bible_books(id) NOT NULL,
    chapter_number INTEGER NOT NULL,
    day_number INTEGER NOT NULL,
    is_completed BOOLEAN DEFAULT false,
    completed_at TIMESTAMPTZ,
    user_notes TEXT,
    UNIQUE(plan_id, day_number)
);

-- Tabela de histórico de leitura
CREATE TABLE reading_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) NOT NULL,
    book_id UUID REFERENCES bible_books(id) NOT NULL,
    chapter_number INTEGER NOT NULL,
    translation_id UUID REFERENCES bible_translations(id),
    read_duration_seconds INTEGER,
    read_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, book_id, chapter_number, read_at::DATE)
);

-- Tabela de marcações e destaques
CREATE TABLE verse_highlights (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) NOT NULL,
    verse_id UUID REFERENCES bible_verses(id) NOT NULL,
    color VARCHAR(20) NOT NULL, -- yellow, blue, green, pink, purple
    highlight_text TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tabela de notas pessoais
CREATE TABLE user_notes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) NOT NULL,
    verse_id UUID REFERENCES bible_verses(id),
    note_title VARCHAR(255),
    note_content TEXT NOT NULL,
    note_type VARCHAR(50) DEFAULT 'personal', -- personal, study, sermon
    is_public BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tabela de orações
CREATE TABLE prayers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) NOT NULL,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    prayer_type VARCHAR(50) DEFAULT 'request', -- request, thanksgiving, confession
    emotional_state VARCHAR(50), -- happy, sad, anxious, peaceful
    is_answered BOOLEAN DEFAULT false,
    answered_at TIMESTAMPTZ,
    answer_notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 1.4 Tabelas de Comunidade

```sql
-- Tabela de posts comunitários
CREATE TABLE community_posts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) NOT NULL,
    group_id UUID REFERENCES groups(id),
    verse_id UUID REFERENCES bible_verses(id),
    title VARCHAR(255),
    content TEXT NOT NULL,
    post_type VARCHAR(50) DEFAULT 'reflection', -- reflection, question, testimony
    is_public BOOLEAN DEFAULT true,
    like_count INTEGER DEFAULT 0,
    comment_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tabela de comentários
CREATE TABLE post_comments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    post_id UUID REFERENCES community_posts(id) NOT NULL,
    user_id UUID REFERENCES users(id) NOT NULL,
    parent_comment_id UUID REFERENCES post_comments(id), -- Para respostas
    content TEXT NOT NULL,
    like_count INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tabela de reações
CREATE TABLE post_reactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    post_id UUID REFERENCES community_posts(id),
    comment_id UUID REFERENCES post_comments(id),
    user_id UUID REFERENCES users(id) NOT NULL,
    reaction_type VARCHAR(20) NOT NULL, -- like, love, thankful, insightful
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, post_id, comment_id)
);

-- Tabela de membros de grupo
CREATE TABLE group_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    group_id UUID REFERENCES groups(id) NOT NULL,
    user_id UUID REFERENCES users(id) NOT NULL,
    role VARCHAR(20) DEFAULT 'member', -- member, moderator, leader
    joined_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(group_id, user_id)
);
```

### 1.5 Tabelas de Gamificação e Conteúdo

```sql
-- Tabela de conquistas
CREATE TABLE achievements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    icon_url TEXT,
    achievement_type VARCHAR(50) NOT NULL, -- reading, community, consistency
    requirement_value INTEGER NOT NULL,
    requirement_metric VARCHAR(50) NOT NULL, -- days_streak, chapters_read, etc.
    tier VARCHAR(20) DEFAULT 'bronze' -- bronze, silver, gold, platinum
);

-- Tabela de conquistas dos usuários
CREATE TABLE user_achievements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) NOT NULL,
    achievement_id UUID REFERENCES achievements(id) NOT NULL,
    progress_value INTEGER DEFAULT 0,
    is_unlocked BOOLEAN DEFAULT false,
    unlocked_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, achievement_id)
);

-- Tabela de streaks
CREATE TABLE reading_streaks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) NOT NULL,
    current_streak INTEGER DEFAULT 0,
    longest_streak INTEGER DEFAULT 0,
    last_reading_date DATE,
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id)
);

-- Tabela de conteúdo adicional
CREATE TABLE additional_content (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    content_type VARCHAR(50) NOT NULL, -- podcast, devotional, study_guide
    audio_url TEXT,
    duration_seconds INTEGER,
    author VARCHAR(255),
    access_level VARCHAR(20) DEFAULT 'premium',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tabela de relacionamento conteúdo-Bíblia
CREATE TABLE content_verse_references (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    content_id UUID REFERENCES additional_content(id) NOT NULL,
    verse_id UUID REFERENCES bible_verses(id) NOT NULL,
    relevance_score DECIMAL(3,2) DEFAULT 1.0,
    UNIQUE(content_id, verse_id)
);
```

## 2. Índices Recomendados

```sql
-- Índices para performance de consultas bíblicas
CREATE INDEX idx_bible_verses_book_chapter_verse ON bible_verses(book_id, chapter_number, verse_number);
CREATE INDEX idx_bible_verses_translation ON bible_verses(translation_id);
CREATE INDEX idx_bible_verses_text_search ON bible_verses USING gin(to_tsvector('portuguese', verse_text));

-- Índices para dados de usuário
CREATE INDEX idx_reading_history_user_date ON reading_history(user_id, read_at);
CREATE INDEX idx_user_notes_user_verse ON user_notes(user_id, verse_id);
CREATE INDEX idx_prayers_user_created ON prayers(user_id, created_at);

-- Índices para comunidade
CREATE INDEX idx_community_posts_group_created ON community_posts(group_id, created_at);
CREATE INDEX idx_community_posts_user_created ON community_posts(user_id, created_at);
CREATE INDEX idx_post_comments_post_created ON post_comments(post_id, created_at);

-- Índices para gamificação
CREATE INDEX idx_user_achievements_progress ON user_achievements(user_id, is_unlocked, progress_value);
CREATE INDEX idx_reading_streaks_current ON reading_streaks(current_streak DESC);

-- Índices para planos de leitura
CREATE INDEX idx_reading_plan_items_plan_day ON reading_plan_items(plan_id, day_number);
CREATE INDEX idx_reading_plans_user_active ON reading_plans(user_id, is_active);
```

## 3. Políticas de Segurança (RLS)

### 3.1 Ativação RLS em todas as tabelas

```sql
-- Ativar RLS em todas as tabelas
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE churches ENABLE ROW LEVEL SECURITY;
ALTER TABLE groups ENABLE ROW LEVEL SECURITY;
ALTER TABLE bible_verses ENABLE ROW LEVEL SECURITY;
ALTER TABLE reading_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE prayers ENABLE ROW LEVEL SECURITY;
ALTER TABLE community_posts ENABLE ROW LEVEL SECURITY;
-- ... e todas as demais tabelas
```

### 3.2 Políticas específicas

```sql
-- Políticas para users
CREATE POLICY "Users can view own profile" ON users
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON users
    FOR UPDATE USING (auth.uid() = id);

-- Políticas para conteúdo bíblico (público)
CREATE POLICY "Bible verses are readable by all" ON bible_verses
    FOR SELECT USING (true);

-- Políticas para dados pessoais
CREATE POLICY "Users can CRUD own reading plans" ON reading_plans
    FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can CRUD own notes" ON user_notes
    FOR ALL USING (auth.uid() = user_id);

CREATE POLICY "Users can CRUD own prayers" ON prayers
    FOR ALL USING (auth.uid() = user_id);

-- Políticas para comunidade
CREATE POLICY "Users can view public posts" ON community_posts
    FOR SELECT USING (is_public = true OR auth.uid() = user_id);

CREATE POLICY "Users can create posts" ON community_posts
    FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own posts" ON community_posts
    FOR UPDATE USING (auth.uid() = user_id);

-- Políticas para grupos
CREATE POLICY "Group members can view group posts" ON community_posts
    FOR SELECT USING (
        group_id IN (
            SELECT group_id FROM group_members 
            WHERE user_id = auth.uid()
        )
    );

-- Políticas para administradores
CREATE POLICY "Super admins have full access" ON users
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM users 
            WHERE id = auth.uid() AND profile_type = 'super_admin'
        )
    );
```

## 4. Funções e Triggers

```sql
-- Função para atualizar updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Triggers para updated_at
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_notes_updated_at BEFORE UPDATE ON user_notes
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Função para atualizar streaks
CREATE OR REPLACE FUNCTION update_reading_streak()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO reading_streaks (user_id, current_streak, longest_streak, last_reading_date)
    VALUES (NEW.user_id, 1, 1, NEW.read_at::DATE)
    ON CONFLICT (user_id) DO UPDATE SET
        current_streak = CASE 
            WHEN reading_streaks.last_reading_date = NEW.read_at::DATE - INTERVAL '1 day' 
            THEN reading_streaks.current_streak + 1
            ELSE 1
        END,
        longest_streak = GREATEST(
            reading_streaks.longest_streak,
            CASE 
                WHEN reading_streaks.last_reading_date = NEW.read_at::DATE - INTERVAL '1 day' 
                THEN reading_streaks.current_streak + 1
                ELSE 1
            END
        ),
        last_reading_date = NEW.read_at::DATE,
        updated_at = NOW();
    
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER trigger_update_streak AFTER INSERT ON reading_history
    FOR EACH ROW EXECUTE FUNCTION update_reading_streak();
```

## 5. Considerações de Implementação

### 5.1 Estratégia de Particionamento
- `reading_history` particionada por mês para melhor performance
- `bible_verses` particionada por tradução para otimização de consultas

### 5.2 Backup e Recuperação
- Backup automático diário no Supabase
- Point-in-time recovery habilitado
- Backup de dados críticos em cloud storage separado

### 5.3 Monitoramento
- Logs de auditoria para ações administrativas
- Métricas de performance para consultas frequentes