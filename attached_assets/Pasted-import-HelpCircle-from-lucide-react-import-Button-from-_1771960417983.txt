import { HelpCircle } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useEffect, useRef, useState } from "react";

export function HelpButton() {
  const loaded = useRef(false);
  const [ready, setReady] = useState(false);

  useEffect(() => {
    if (loaded.current) return;
    loaded.current = true;

    const style = document.createElement("style");
    style.textContent = `
      #rf-panel {
        max-width: calc(100vw - 32px) !important;
        width: 370px !important;
        max-height: calc(100vh - 120px) !important;
        bottom: 60px !important;
        top: 80px !important;
        right: 16px !important;
        border-radius: 16px !important;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2) !important;
        z-index: 9998 !important;
      }
      @media (max-width: 768px) {
        #rf-panel {
          width: auto !important;
          max-width: none !important;
          max-height: 420px !important;
          height: 60vh !important;
          top: auto !important;
          bottom: 12px !important;
          right: 12px !important;
          left: 12px !important;
          border-radius: 12px !important;
        }
      }
    `;
    document.head.appendChild(style);

    const script = document.createElement("script");
    script.src = "https://relpflow-fabriciosantossilva.replit.app/widget.js";
    script.setAttribute("data-key", "wk_26ab14f77fac22c7026c190cd9960b7c17d382c31692a452");
    script.setAttribute("data-hide-fab", "true");
    script.onload = () => setReady(true);
    document.body.appendChild(script);
  }, []);

  const handleClick = () => {
    try {
      const relpflow = (window as any).RelpFlow;
      if (relpflow && typeof relpflow.toggle === "function") {
        relpflow.toggle();
        return;
      }
      const panel = document.getElementById("rf-panel");
      if (panel) panel.classList.toggle("rf-open");
    } catch (e) {
      console.warn("[HelpButton] Could not open widget:", e);
    }
  };

  return (
    <Button
      variant="outline"
      size="icon"
      onClick={handleClick}
      data-testid="button-help-relpflow"
      title="Central de Ajuda"
      className="h-10 w-10 rounded-xl bg-gradient-to-br from-purple-500/15 to-indigo-500/15"
    >
      <HelpCircle className="h-9 w-9 text-purple-500 dark:text-purple-400 animate-pulse" />
      <span className="sr-only">Central de Ajuda</span>
    </Button>
  );
}