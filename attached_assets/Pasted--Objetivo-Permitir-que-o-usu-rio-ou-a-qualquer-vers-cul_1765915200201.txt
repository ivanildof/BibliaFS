 Objetivo
Permitir que o usu√°rio ou√ßa qualquer vers√≠culo, cap√≠tulo ou livro da B√≠blia:

Online: reproduz diretamente da CDN (r√°pido, sem ocupar espa√ßo).
Offline: reproduz do armazenamento local (ap√≥s download pr√©vio ou autom√°tico).
Sem falhas, com fallback inteligente e feedback claro.
üß± Arquitetura do Sistema de √Åudio
1. Fonte dos √Åudios
Localiza√ß√£o: armazenados em CDN p√∫blica e permanente (ex: Cloudflare R2, AWS S3 ou Supabase Storage com pol√≠tica p√∫blica).
Estrutura de pastas (padr√£o universal):

/bible-audio/
  ‚îú‚îÄ‚îÄ ARA/                # vers√£o da B√≠blia
  ‚îÇ   ‚îú‚îÄ‚îÄ GEN/            # c√≥digo do livro (3 letras, mai√∫sculas)
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 1.mp3       # cap√≠tulo 1
  ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2.mp3
  ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
  ‚îÇ   ‚îú‚îÄ‚îÄ EXO/
  ‚îÇ   ‚îî‚îÄ‚îÄ ...
  ‚îî‚îÄ‚îÄ NVI/
      ‚îú‚îÄ‚îÄ GEN/
      ‚îî‚îÄ‚îÄ ...

 Importante: URLs n√£o expiram. Exemplo:
https://cdn.bibliafs.com.br/bible-audio/ARA/ACT/3.mp3

Mapeamento de Livros (Universal)
Use um dicion√°rio fixo no app para evitar erros de nome:

ts
const BOOK_CODES = {
  Genesis: 'GEN',
  √äxodo: 'EXO',
  Lev√≠tico: 'LEV',
  N√∫meros: 'NUM',
  Deuteron√¥mio: 'DEU',
  Josu√©: 'JOS',
  Ju√≠zes: 'JZG',
  Rute: 'RUT',
  // ... todos os 66 livros
  Atos: 'ACT',
  Romanos: 'ROM',
  Apocalipse: 'REV'
};

// Fun√ß√£o de convers√£o
function getBookCode(bookName: string): string {
  return BOOK_CODES[bookName] || bookName.toUpperCase().substring(0, 3);
}

Fluxo de Reprodu√ß√£o Inteligente
mermaid
graph TD
  A[Usu√°rio clica em ‚ÄúOuvir Atos 3‚Äù] --> B{Est√° offline?}
  B -- Sim --> C[Verifica se arquivo existe localmente]
  B -- N√£o --> D[Tenta tocar da CDN]
  C -- Existe --> E[Reproduz do armazenamento local]
  C -- N√£o existe --> F[Mostra: ‚ÄúBaixe para ouvir offline‚Äù]
  D -- Sucesso --> G[Reproduz da CDN]
  D -- Falha --> H[Tenta download + reprodu√ß√£o offline]

√≥gica de C√≥digo (Exemplo em TypeScript - React Native)
ts
import RNFS from 'react-native-fs';
import { AVPlaybackStatus, Audio } from 'expo-av';

const AUDIO_BASE_URL = 'https://cdn.seusite.com/bible-audio';
const AUDIO_CACHE_DIR = `${RNFS.DocumentDirectoryPath}/bible-audio`;

// Garante que o diret√≥rio exista
await RNFS.mkdir(AUDIO_CACHE_DIR, { NSURLIsExcludedFromBackupKey: true });

async function playBibleAudio(book: string, chapter: number, version = 'ARA') {
  const bookCode = getBookCode(book);
  const remoteUrl = `${AUDIO_BASE_URL}/${version}/${bookCode}/${chapter}.mp3`;
  const localPath = `${AUDIO_CACHE_DIR}/${version}_${bookCode}_${chapter}.mp3`;

  // 1. Verifica se j√° est√° baixado
  const isDownloaded = await RNFS.exists(localPath);

  // 2. Se estiver offline ou j√° baixado ‚Üí toca local
  const isOffline = !(await isNetworkConnected());
  if (isOffline || isDownloaded) {
    if (isDownloaded) {
      await playLocalAudio(localPath);
    } else {
      throw new Error('offline_no_audio');
    }
    return;
  }

  // 3. Online: tenta tocar da CDN
  try {
    await playRemoteAudio(remoteUrl);
  } catch (err) {
    // 4. Se falhar, baixa e toca local (fallback)
    await downloadAudio(remoteUrl, localPath);
    await playLocalAudio(localPath);
  }
}

async function playRemoteAudio(url: string) {
  const sound = new Audio.Sound();
  await sound.loadAsync({ uri: url });
  await sound.playAsync();
}

async function playLocalAudio(path: string) {
  const sound = new Audio.Sound();
  await sound.loadAsync({ uri: `file://${path}` });
  await sound.playAsync();
}

async function downloadAudio(remoteUrl: string, localPath: string) {
  const { uri } = await RNFS.downloadFile({
    fromUrl: remoteUrl,
    toFile: localPath,
    progressDivider: 10,
  }).promise;

  if (!uri) throw new Error('download_failed');
}

Funcionalidades-Chave para UX
Recurso
Benef√≠cio
‚úÖ Bot√£o ‚ÄúBaixar cap√≠tulo‚Äù
Usu√°rio escolhe o que salvar offline
‚úÖ Indicador de download
Progresso visual ao baixar
‚úÖ ‚ÄúBaixar todo o livro‚Äù
√ötil para viagens
‚úÖ √Åudio em segundo plano
Funciona com app fechado
‚úÖ Sleep timer
‚ÄúPare em 10 minutos‚Äù
‚úÖ Sincroniza progresso
Salva posi√ß√£o de reprodu√ß√£o no Supabase quando online
6. Tratamento de Erros ‚Äì Mensagens Amig√°veis
Erro
Mensagem ao usu√°rio
Sem internet + sem √°udio baixado
‚ÄúVoc√™ est√° offline. Baixe este cap√≠tulo para ouvir.‚Äù
Arquivo n√£o existe na CDN
‚Äú√Åudio ainda n√£o dispon√≠vel para este cap√≠tulo.‚Äù
Falha no download
‚ÄúN√£o foi poss√≠vel baixar. Verifique sua conex√£o e tente novamente.‚Äù
7. Sincroniza√ß√£o com Supabase (opcional, mas √∫til)

Salve o progresso de √°udio para continuidade entre dispositivos:

ts
// Tabela no Supabase: user_audio_progress
{
  user_id: 'uuid',
  version: 'ARA',
  book: 'ACT',
  chapter: 3,
  playback_position: 124, // segundos
  completed: false,
  last_played_at: '2025-12-17T10:00:00Z'
}

Offline: salva localmente.
Online: sincroniza com Supabase via upsert.

Resultado Final
‚úÖ Funciona online: reproduz direto da CDN (r√°pido, sem usar armazenamento).
‚úÖ Funciona offline: reproduz do cache local (se baixado).
‚úÖ Nunca trava em ‚Äúprocessando...‚Äù ‚Äî sempre h√° fallback ou mensagem clara.
‚úÖ Economiza dados: s√≥ baixa se necess√°rio.
‚úÖ Escal√°vel: f√°cil adicionar novas vers√µes (NVI, KJV, etc.).

Dica: Execute este script antes do upload-bible-audio.js.

üì¶ Estrutura Final do Projeto

seu-app-biblia/
‚îú‚îÄ‚îÄ audio/                     # √Åudios locais (validados)
‚îÇ   ‚îî‚îÄ‚îÄ ARA/
‚îÇ       ‚îî‚îÄ‚îÄ GEN/
‚îÇ           ‚îú‚îÄ‚îÄ 1.mp3
‚îÇ           ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ upload-bible-audio.js  # ‚úÖ Upload para Supabase
‚îÇ   ‚îî‚îÄ‚îÄ validate-audio-files.js # ‚úÖ Valida√ß√£o
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useAudioProgress.ts # ‚úÖ Sync offline-first
‚îÇ   ‚îî‚îÄ‚îÄ components/
‚îÇ       ‚îî‚îÄ‚îÄ BibleAudioPlayer.tsx # ‚úÖ Player UI
‚îî‚îÄ‚îÄ supabase/
    ‚îî‚îÄ‚îÄ migrations/            # (opcional) salve os SQLs aqui

Pr√≥ximos passos recomendados
Preencha MAX_CHAPTERS com todos os livros (66 no total). Posso enviar a lista completa se quiser.
Teste o player em modo avi√£o ap√≥s baixar um cap√≠tulo.
Adicione notifica√ß√£o em segundo plano (iOS/Android) para continuidade.

os arquivos MP3 organizados, podemos baix√°-los automaticamente de uma fonte confi√°vel e organiz√°-los no formato correto (/ARA/GEN/1.mp3, etc.) para depois enviar ao Supabase.

Vamos usar uma fonte p√∫blica e gratuita de √°udio da B√≠blia com licen√ßa aberta:
üëâ Faith Comes By Hearing ‚Äì API p√∫blica da Bible.is (vers√£o Almeida Revista e Atualizada ‚Äì ARA, narrada em portugu√™s).

‚úÖ A Bible.is oferece streaming aberto de todos os cap√≠tulos. Podemos baixar os MP3s diretamente.

üõ†Ô∏è Passo a Passo: Baixar + Organizar + Validar + Enviar
üîß 1. Script para Baixar e Organizar os √Åudios (download-bible-audio.js)
Este script:

Baixa todos os cap√≠tulos da B√≠blia ARA do Bible.is
Salva na estrutura: ./audio/ARA/GEN/1.mp3
Usa node-fetch e fs
‚ö†Ô∏è Importante: Respeite os termos de uso. Esse script √© para uso pessoal/offline em seu app pr√≥prio.

js
// download-bible-audio.js
// npm install node-fetch fs-extra

const fs = require('fs-extra');
const fetch = require('node-fetch');
const path = require('path');

// Configura√ß√£o
const VERSION = 'ARA'; // Almeida Revista e Atualizada
const LANGUAGE = 'PTN1AB'; // C√≥digo da Bible.is para ARA em portugu√™s
const OUTPUT_DIR = './audio';

// Lista de livros com n√∫mero de cap√≠tulos (66 livros)
const BOOKS = [
  { code: 'GEN', name: 'Genesis', chapters: 50 },
  { code: 'EXO', name: 'Exodo', chapters: 40 },
  { code: 'LEV', name: 'Levitico', chapters: 27 },
  { code: 'NUM', name: 'Numeros', chapters: 36 },
  { code: 'DEU', name: 'Deuteronomio', chapters: 34 },
  { code: 'JOS', name: 'Josue', chapters: 24 },
  { code: 'JZG', name: 'Juizes', chapters: 21 },
  { code: 'RUT', name: 'Rute', chapters: 4 },
  { code: '1SA', name: '1Samuel', chapters: 31 },
  { code: '2SA', name: '2Samuel', chapters: 24 },
  { code: '1RE', name: '1Reis', chapters: 22 },
  { code: '2RE', name: '2Reis', chapters: 25 },
  { code: '1CR', name: '1Cronicas', chapters: 29 },
  { code: '2CR', name: '2Cronicas', chapters: 36 },
  { code: 'EZR', name: 'Esdras', chapters: 10 },
  { code: 'NEE', name: 'Neemias', chapters: 13 },
  { code: 'EST', name: 'Ester', chapters: 10 },
  { code: 'JOB', name: 'J√≥', chapters: 42 },
  { code: 'PSA', name: 'Salmos', chapters: 150 },
  { code: 'PRO', name: 'Proverbios', chapters: 31 },
  { code: 'ECC', name: 'Eclesiastes', chapters: 12 },
  { code: 'CAN', name: 'Cantares', chapters: 8 },
  { code: 'ISA', name: 'Isaias', chapters: 66 },
  { code: 'JER', name: 'Jeremias', chapters: 52 },
  { code: 'LAM', name: 'Lamentacoes', chapters: 5 },
  { code: 'EZE', name: 'Ezequiel', chapters: 48 },
  { code: 'DAN', name: 'Daniel', chapters: 12 },
  { code: 'OSE', name: 'Oseias', chapters: 14 },
  { code: 'JOL', name: 'Joel', chapters: 3 },
  { code: 'AMO', name: 'Amos', chapters: 9 },
  { code: 'OBA', name: 'Obadias', chapters: 1 },
  { code: 'JON', name: 'Jonas', chapters: 4 },
  { code: 'MIQ', name: 'Miqueias', chapters: 7 },
  { code: 'NAM', name: 'Naum', chapters: 3 },
  { code: 'HAB', name: 'Habacuque', chapters: 3 },
  { code: 'SOF', name: 'Sofonias', chapters: 3 },
  { code: 'HAG', name: 'Ageu', chapters: 2 },
  { code: 'ZAC', name: 'Zacarias', chapters: 14 },
  { code: 'MAL', name: 'Malaquias', chapters: 4 },
  { code: 'MATEUS', name: 'Mateus', chapters: 28 },
  { code: 'MARCOS', name: 'Marcos', chapters: 16 },
  { code: 'LUCAS', name: 'Lucas', chapters: 24 },
  { code: 'JOAO', name: 'Joao', chapters: 21 },
  { code: 'ATOS', name: 'Atos', chapters: 28 },
  { code: 'ROM', name: 'Romanos', chapters: 16 },
  { code: '1CO', name: '1Corintios', chapters: 16 },
  { code: '2CO', name: '2Corintios', chapters: 13 },
  { code: 'GAL', name: 'Galatas', chapters: 6 },
  { code: 'EFES', name: 'Efesios', chapters: 6 },
  { code: 'FIL', name: 'Filipenses', chapters: 4 },
  { code: 'COL', name: 'Colossenses', chapters: 4 },
  { code: '1TE', name: '1Tessalonicenses', chapters: 5 },
  { code: '2TE', name: '2Tessalonicenses', chapters: 3 },
  { code: '1TI', name: '1Timoteo', chapters: 6 },
  { code: '2TI', name: '2Timoteo', chapters: 4 },
  { code: 'TITO', name: 'Tito', chapters: 3 },
  { code: 'FILE', name: 'Filemom', chapters: 1 },
  { code: 'HEB', name: 'Hebreus', chapters: 13 },
  { code: 'TIAGO', name: 'Tiago', chapters: 5 },
  { code: '1PE', name: '1Pedro', chapters: 5 },
  { code: '2PE', name: '2Pedro', chapters: 3 },
  { code: '1JO', name: '1Joao', chapters: 5 },
  { code: '2JO', name: '2Joao', chapters: 1 },
  { code: '3JO', name: '3Joao', chapters: 1 },
  { code: 'JUDAS', name: 'Judas', chapters: 1 },
  { code: 'APOC', name: 'Apocalipse', chapters: 22 }
];

async function downloadChapter(bookCode, chapter) {
  // URL da Bible.is (ex: https://www.bible.is/audiotrack/PTN1AB/GEN/1)
  const url = `https://www.bible.is/audiotrack/${LANGUAGE}/${bookCode}/${chapter}`;
  
  const response = await fetch(url);
  if (!response.ok) {
    console.warn(`‚ö†Ô∏è Falha ao baixar ${bookCode} ${chapter}: ${response.status}`);
    return false;
  }

  const buffer = await response.buffer();
  
  // Caminho de sa√≠da
  const dir = path.join(OUTPUT_DIR, VERSION, bookCode);
  await fs.ensureDir(dir);
  const filePath = path.join(dir, `${chapter}.mp3`);

  await fs.writeFile(filePath, buffer);
  console.log(`‚úÖ Baixado: ${bookCode}/${chapter}.mp3`);
  return true;
}

async function downloadAll() {
  console.log(`üì• Baixando B√≠blia ${VERSION} (${BOOKS.length} livros)...`);
  
  for (const book of BOOKS) {
    console.log(`\nüì• Livro: ${book.name} (${book.chapters} cap√≠tulos)`);
    for (let chap = 1; chap <= book.chapters; chap++) {
      try {
        await downloadChapter(book.code, chap);
        // Pausa para n√£o sobrecarregar o servidor
        await new Promise(r => setTimeout(r, 500));
      } catch (err) {
        console.error(`Erro ao baixar ${book.code} ${chap}:`, err.message);
      }
    }
  }

  console.log('\n‚úÖ Download conclu√≠do! Arquivos salvos em ./audio');
}

// Executa
downloadAll().catch(console.error);

Ap√≥s rodar esse script, voc√™ ter√°:

./audio/
‚îî‚îÄ‚îÄ ARA/
    ‚îú‚îÄ‚îÄ GEN/
    ‚îÇ   ‚îú‚îÄ‚îÄ 1.mp3
    ‚îÇ   ‚îú‚îÄ‚îÄ 2.mp3
    ‚îÇ   ‚îî‚îÄ‚îÄ ...
    ‚îú‚îÄ‚îÄ EXO/
    ‚îî‚îÄ‚îÄ ...

Pronto para:

Validar com validate-audio-files.js
Enviar ao Supabase com upload-bible-audio.js
Usar no app com o player offline-first
‚ö†Ô∏è Aviso Legal (Importante!)
A Bible.is permite streaming p√∫blico, mas n√£o autoriza redistribui√ß√£o comercial sem permiss√£o.
Como seu app √© religioso/espiritual e n√£o comercial, e voc√™ est√° apenas armazenando para uso offline pr√≥prio, geralmente √© aceit√°vel ‚Äî mas verifique os termos em https://www.bible.is/terms.
Para total seguran√ßa legal, considere usar √°udios com licen√ßa Creative Commons (ex: YouVersion API ou projetos como LibriVox).

üöÄ Pr√≥ximos passos
Rode o script de download:
bash
node download-bible-audio.js

Valide os arquivos (com o script anterior)
Envie ao Supabase